<!DOCTYPE html>
<html>
	<head>
		<meta charset=utf-8>
		<title>订单界面</title>
		<link rel=stylesheet href=../css/订单界面.css>
		<style>
			body {
				font: 16px Arial, sans-serif;
				text-align: center
			}

			.main-content {
				width: 90%;
				margin-top: -20px
			}

			select,
			button {
				height: 20px
			}

			button {
				background: #FFA300;
				color: #fff;
				border: 0;
				border-radius: 5px;
				width: 90px
			}

			table {
				width: 100%;
				border-collapse: collapse;
				margin-top: 20px
			}

			th,
			td {
				border: 1px solid #000;
				padding: 8px
			}

			th {
				background: #242F3B;
				color: #fff
			}

			.user-search,
			.time-search {
				display: none
			}

			.download-container {
				margin-top: -110px;
				margin-left: 700px
			}

			/* 一个 */
			.table-container {
				max-height: 400px;
				overflow-y: auto
			}

			#xainshi {
				text-align: center;
				position: absolute;
				top: calc(50% - 260px);
				left: calc(50% - 360px)
			}

			#w {
				display: none;
				position: fixed;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				background: rgba(0, 0, 0, 0.5);
				justify-content: center;
				align-items: center;
				z-index: 999
			}

			#wll {
				width: 500px;
				height: 350px;
				background: #fff;
				padding: 20px;
				border-radius: 5px;
				text-align: center
			}

			.yd {
				margin-left: 890px;
				width: 80px;
				height: 45px;
				background: #FFA300;
				border: 0;
				color: #fff
			}

			.download-container {
				margin-top: 20px;
				margin-left: 250px
			}

			.user-search {
				margin-left: -500px;
				margin-top: -40px
			}

			.time-search {
				margin-left: -690px;
				margin-top: -23px
			}
		</style>
	</head>
	<body><input type=submit value=下载 onclick=w.style.display='flex' class=yd>
		<div id=w>
			<div id=xainshi>
				<div class=download-container><input type=text id=wenjmz placeholder="输入文件名"><button class=download-btn
						onclick=exportToCSV()>生成Excel文件</button></div>
			</div>
		</div>
		<div class=main-content>
			<h2 style=margin-left:20px>查询模式：</h2><select id=query-mode-select onchange=toggleSearchInputs()></select>
			<div class=user-search><label for=username-input>用户名：</label><input type=text id=username-input></div><br>
			<div class=time-search><label for=start-time>开始时间：</label><input type=datetime-local id=start-time
					step=1><label for=end-time>结束时间：</label><input type=datetime-local id=end-time step=1></div>
			<br><button id=search-button onclick=performSearch()>查询</button>
			<div class=table-container>
				<table id=order-table>
					<thead>
						<tr>
							<th>订单编号</th>
							<th>显示类型</th>
							<th>用户类型</th>
							<th>用户名</th>
							<th>启动时间</th>
							<th>下单时间</th>
							<th>数量</th>
							<th>装配时间</th>
							<th>钻孔时间</th>
							<th>装配次数</th>
							<th>钻孔次数</th>
							<th>状态</th>
						</tr>
					</thead>
					<tbody></tbody>
				</table>
			</div>
		</div>
		<div class=ymtz>
			<ul>
				<li><a href=首页.html>首页</a></li>
				<li><a href=状态界面.html>状态监控</a></li>
				<li><a href=数据监控.html>数据监控</a></li>
				<li><a href=订单界面.html>订单界面</a></li>
				<li><a href=订单查询.html>订单查询</a></li>
				<li><a href=报警记录.html>报警记录</a></li>
				<li><a href=用户管理.html>用户管理</a></li>
			</ul>
		</div>
		<script>
			const queryModeSelect = document.getElementById('query-mode-select'),
				options = [{
					value: '',
					text: '',
					style: 'display:none'
				}, {
					value: '1',
					text: ' 所有订单'
				}, {
					value: '2',
					text: '用户'
				}, {
					value: '3',
					text: '时间段查询'
				}];
			options.forEach(o => {
				const e = document.createElement('option');
				e.value = o.value, e.textContent = o.text, e.style = o.style, queryModeSelect.appendChild(e)
			});
			const userSearch = document.querySelector('.user-search'),
				timeSearch = document.querySelector('.time-search'),
				usernameInput = document.getElementById('username-input'),
				startTimeInput = document.getElementById('start-time'),
				endTimeInput = document.getElementById('end-time'),
				tableBody = document.querySelector('#order-table  tbody');

			function toggleSearchInputs() {
				const e = queryModeSelect.value;
				[usernameInput, startTimeInput, endTimeInput].forEach(e => e.value = ''), userSearch.style.display =
					e === '2' ? 'block' : 'none', timeSearch.style.display = e === '3' ? 'block' : 'none'
			}

			function formatDate(e) {
				const t = e.getFullYear(),
					n = String(e.getMonth() + 1).padStart(2, '0'),
					o = String(e.getDate()).padStart(2, '0'),
					a = String(e.getHours()).padStart(2, '0'),
					r = String(e.getMinutes()).padStart(2, '0'),
					s = String(e.getSeconds()).padStart(2, '0');
				return `${t} 年${n}月${o}日  ${a}:${r}:${s}`
			}
			async function performSearch() {
				const mode = queryModeSelect.value;
				const username = usernameInput.value.trim();
				let startTime = startTimeInput.value;
				let endTime = endTimeInput.value;

				// 参数验证
				if (mode === '2' && !username) {
					return alert('请输入用户名');
				}

				if (mode === '3') {
					if (!startTime || !endTime) {
						return alert('请选择开始时间和结束时间');
					}

					// 转换为ISO格式，但不移除时区信息
					startTime = new Date(startTime).toISOString();
					endTime = new Date(endTime).toISOString();

					if (new Date(startTime) > new Date(endTime)) {
						return alert('开始时间不能晚于结束时间');
					}
				}

				try {
					const url = new URL('http://127.0.0.1:1880/order');
					url.searchParams.set('mode', mode);

					if (mode === '2') {
						url.searchParams.set('username', username);
					} else if (mode === '3') {
						url.searchParams.set('startTime', startTime);
						url.searchParams.set('endTime', endTime);
					}

					// 显示加载状态
					tableBody.innerHTML = '<tr><td colspan="12">加载中...</td></tr>';

					const response = await fetch(url);

					// 检查HTTP状态码
					if (!response.ok) {
						throw new Error(`HTTP错误: ${response.status}`);
					}

					const data = await response.json();

					if (data.error) {
						throw new Error(data.error);
					}

					// 清空表格并填充数据
					tableBody.innerHTML = '';

					if (data.length === 0) {
						tableBody.innerHTML = '<tr><td colspan="12">没有找到匹配的订单</td></tr>';
						return;
					}

					data.forEach(order => {
						const row = document.createElement('tr');
						['ddbh', 'xslx', 'yhlx', 'yhmc', 'qdsj', 'xdsj', 'sl', 'zpsj', 'zksj', 'zpcs', 'zkcs', 'zt']
						.forEach(column => {
							const cell = document.createElement('td');
							let value = order[column];

							// 格式化日期列
							if (['qdsj', 'xdsj'].includes(column) && value) {
								value = formatDate(new Date(value));
							}

							cell.textContent = value || '-';
							row.appendChild(cell);
						});
						tableBody.appendChild(row);
					});
				} catch (error) {
					console.error('获取数据失败:', error);
					tableBody.innerHTML = `<tr><td colspan="12">查询失败: ${error.message}</td></tr>`;

					// 显示更友好的错误提示
					if (error.message.includes('NetworkError')) {
						alert('无法连接到服务器，请检查网络连接');
					} else if (error.message.includes('JSON')) {
						alert('服务器返回的数据格式不正确');
					}
				}
			}
		</script>
	</body>
</html>