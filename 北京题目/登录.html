<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <link rel="stylesheet" href="./css/登录.css" />
        <title></title>
    </head>
    <body>
        <div class="bjt">
            <h1>工业4.0信息管理系统</h1>
            <div class="srk">
                <img src="./img/yonghu.png" alt="" />
                <input type="text" id="u" placeholder="用户名" />
            </div>
            <div class="srk">
                <img src="./img/yuechi.png" alt="" />
                <input type="password" id="p" placeholder="密码" />
            </div>
            <div class="wos">
                <input type="checkbox" />记住密码
            </div>
            <div class="ann">
                <button onclick="l()">登录</button>
                <button><a href="注册.html">注册</a></button>
            </div>
        </div>
        <script>
            let i = 0;
            const b = ["./img/内容图.jpg", "./img/背景图3.jpg", "./img/背景图1.jpg"];
            document.body.style.backgroundImage = `url(${b[i]})`;
            setInterval(() => document.body.style.backgroundImage = `url(${b[i++ % 3]})`, 2e3);
            
            const f = {}, lk = {};
            const btn = document.querySelector('button');
            
            const l = () => {
                const u = document.getElementById('u').value.trim(), 
                      p = document.getElementById('p').value.trim();
                const lt = lk[u];
                if (lt > Date.now()) {
                    btn.disabled = true;
                    btn.textContent = `等${Math.ceil((lt - Date.now()) / 1000)}秒`;
                    return setTimeout(l, 1000);
                }
            
                fetch(`http://127.0.0.1:1880/dl?username=${encodeURIComponent(u)}&password=${encodeURIComponent(p)}`)
                   // 将响应数据转换为 JSON 格式
                   .then(r => r.json())
                   .then(d => {
                        if (d.statusCode === 200) {
                            // 登录成功
                            f[u] = 0;
                            localStorage.setItem('username', u);
                            localStorage.setItem('usertype', d.usertype);
                            window.location.href = {
                                '超级管理员': '超级管理员/首页.html',
                                '工厂管理员': '工厂管理员/首页.html',
                                '车间管理员': '车间管理员/首页.html',
                                '操作工': '操作工/首页.html'
                            }[d.usertype];
                        } else if (d.statusCode === 205) {
                            // 密码错误
                            (f[u] = (f[u] || 0) + 1) >= 3 && (lk[u] = Date.now() + 60000);
                            btn.disabled = f[u] >= 3;
                            btn.textContent = f[u] >= 3 ? '锁定' : '登录';
                            f[u] < 3 && alert(`密码错误，剩余${3 - f[u]}次尝试机会`);
                        } else if (d.statusCode === 201) {
                            // 用户不存在
                            (f[u] = (f[u] || 0) + 1) >= 3 && (lk[u] = Date.now() + 60000);
                            btn.disabled = f[u] >= 3;
                            btn.textContent = f[u] >= 3 ? '锁定' : '登录';
                            f[u] < 3 && alert(`用户不存在，剩余${3 - f[u]}次尝试机会`);
                        } else {
                            // 其他未知状态码
                            alert(`未知错误，状态码: ${d.statusCode}`);
                        }
                    })
                   // 捕获请求过程中可能出现的错误，并弹出提示框显示错误信息
                   .catch(e => alert(e.message));
            };
            // 为 id 为 u 的输入框添加输入事件监听器
            // 当输入框内容发生变化时，将按钮 btn 的文本设置为“登”
            document.getElementById('u').addEventListener('input', () => btn.textContent = '登录');
        </script>
    </body>
</html>